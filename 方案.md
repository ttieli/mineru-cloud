# Mineru CLI 开发与部署方案

为了将开发环境与全局命令解耦，我们采用 **"开发 -> 部署 -> 全局调用"** 的模式。

## 1. 核心架构

*   **开发目录**: 当前目录 (`.../mineru_cloud/`)。您在这里编写代码。
*   **稳定运行目录**: `~/.local/share/mineru/`。存放经过测试、准备发布的“稳定版”代码。
*   **全局命令**: `~/.local/bin/mineru` (PATH 中)。这是一个 Bash 包装器，它只指向 **稳定运行目录** 中的代码，而不指向任何开发目录。

## 2. 本机环境检查（macOS）

* PATH 已包含 `~/.local/bin`（可直接调用全局命令）。
* `wf` 等命令可直接运行，说明 `~/.local/bin` 在 PATH 中（当前 `wf` 位于 `~/.local/bin/wf`）。
* `python3` / `python` 版本：Python 3.13.7（已满足需求）。
* `~/.local/share/mineru` 目前不存在，需要首轮部署时创建。
* 现有 `~/.local/bin/mineru` 指向 `/Users/tieli/Library/Mobile Documents/com~apple~CloudDocs/Project/MinerU/scripts/mineru_cli.py`（当前文件存在），需要按下文替换为稳定目录版本。

## 3. 实施步骤

### 步骤 1: 建立稳定运行目录

首先，我们需要创建一个专门存放稳定版代码的地方，并将当前代码复制进去。

```bash
# 创建稳定目录
mkdir -p ~/.local/share/mineru

# 将当前的 CLI 脚本复制过去作为初始版本
cp mineru_cli.py ~/.local/share/mineru/mineru_cli.py
```

### 步骤 2: 更新全局命令 wrapper

修改您 PATH 中的 `mineru` 脚本，使其指向步骤 1 创建的稳定文件。

**文件**: `/Users/tieli/.local/bin/mineru`

请使用以下内容覆盖该文件（您可以使用 `nano` 或 `vim` 编辑，或者使用下面的命令自动覆盖）：

```bash
cat << 'EOF' > ~/.local/bin/mineru
#!/bin/bash
# mineru - MinerU Cloud OCR CLI
# Global command wrapper pointing to the STABLE installation

# 指向稳定目录，而不是开发目录
SCRIPT_PATH="$HOME/.local/share/mineru/mineru_cli.py"

# Check if Python 3 is available
if command -v python3 &> /dev/null; then
    PYTHON="python3"
elif command -v python &> /dev/null; then
    PYTHON="python"
else
    echo "Error: Python not found. Please install Python 3."
    exit 1
fi

# Check if requests is installed (auto-install if missing)
$PYTHON -c "import requests" 2>/dev/null
if [ $? -ne 0 ]; then
    echo "Installing required dependency: requests"
    $PYTHON -m pip install --user requests -q
fi

# Run the CLI
exec $PYTHON "$SCRIPT_PATH" "$@"
EOF

# 赋予执行权限
chmod +x ~/.local/bin/mineru
```

### 步骤 3: 创建开发部署脚本

在当前开发目录 (`mineru_cloud`) 中创建一个 `deploy.sh` 脚本。当您完成开发并测试通过后，运行此脚本将变更“发布”到全局环境。

**创建 `deploy.sh`**:

```bash
cat << 'EOF' > deploy.sh
#!/bin/bash
# 将当前开发版本的 mineru_cli.py 部署到全局稳定目录

SRC="mineru_cli.py"
DEST="$HOME/.local/share/mineru/mineru_cli.py"

echo "Deploying $SRC to $DEST ..."

mkdir -p "$HOME/.local/share/mineru"

# 简单的语法检查
python3 -m py_compile "$SRC"
if [ $? -ne 0 ]; then
    echo "Error: Syntax check failed. Aborting deployment."
    exit 1
fi

# 复制文件
cp "$SRC" "$DEST"

echo "Deployment successful! The global 'mineru' command is now updated."
EOF

# 赋予执行权限
chmod +x deploy.sh
```

## 4. 使用流程

1.  **开发**: 在当前目录 (`mineru_cloud`) 修改 `mineru_cli.py`。
2.  **测试**: 在当前目录使用 `./mineru_cli.py` 或 `python3 mineru_cli.py` 进行测试。
    *   此时全局的 `mineru` 命令**不会**受到影响。
3.  **发布**: 测试完成后，运行部署脚本：
    ```bash
    ./deploy.sh
    ```
4.  **使用**: 现在全局的 `mineru` 命令已经更新为您最新的代码。

## 5. GitHub + npm 分发方案（跨设备使用）

可行性：可行。将当前项目推到 GitHub，npm 包作为安装器 + wrapper，自动把最新 Release 的 `mineru_cli.py` 部署到本机稳定目录并写入全局命令。

### GitHub 仓库
1. 初始化 Git 仓库并推送到 GitHub（公开或私有），包含 `mineru_cli.py`、`deploy.sh`、`requirements.txt`、`README`、`方案.md`。
2. 发布 Release（如 `v1.0.0`），附上 `mineru_cli.py` 或 zip 资产，供安装器下载。

### npm 包（安装器 + wrapper）
1. 关键文件：
   - `package.json`：`name` 如 `mineru-cli`；`bin` 指向 `bin/mineru`；`scripts.postinstall` 运行 `node scripts/install.js`。
   - `bin/mineru`：Node wrapper，调用 `python3 ~/.local/share/mineru/mineru_cli.py "$@"`（Windows 兼容 `python` 和路径分隔）。
   - `scripts/install.js`：检测 Python/requests（缺失则提示或执行 `pip install --user requests`），创建稳定目录，下载最新 Release 的 `mineru_cli.py` 到稳定目录，写入/覆盖 wrapper（macOS/Linux 用 `~/.local/bin/mineru`，Windows 写 `.cmd`），设置执行权限。
2. 发布与使用：
   - 全局安装：`npm install -g mineru-cli`
   - 即时使用：`npx mineru-cli <file_or_url>`
   - 升级：`npm update -g mineru-cli` 或重新安装。

### 自动化（可选）
- GitHub Actions：推 tag 自动打包 Release 并发布 npm。
- CI 校验：`python3 -m py_compile mineru_cli.py` 确认语法。

### 注意
- 私有仓库时，`install.js` 需要处理下载授权（token 或换公开资产）。
- Windows 需写入 `%APPDATA%\\npm\\mineru.cmd` 或 node 全局 bin，依旧用 `pip install --user requests`。
- 若本机缺少 Python/requests，安装器应给出明确提示并引导。

---

这样，您的开发环境就非常干净且安全，不会意外破坏全局工具的可用性。
